name: Cleanup Cancelled Artifacts

on:
  workflow_run:
    workflows:
      - "CI and Deploy Next app to GitHub Pages"
    types:
      - completed

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'cancelled'
    permissions:
      actions: write
    steps:
      - name: 'Delete artifacts from cancelled workflow run'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run_id = ${{ github.event.workflow_run.id }};
            core.info(`Workflow run ${run_id} was cancelled. Cleaning up its artifacts.`);

            try {
              const { data: { artifacts } } = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run_id,
              });

              if (artifacts.length === 0) {
                core.info("No artifacts found to clean up.");
                return;
              }

              core.info(`Found ${artifacts.length} artifact(s) to delete.`);
              for (const artifact of artifacts) {
                core.info(`Deleting artifact: "${artifact.name}" (ID: ${artifact.id})`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
              core.info(`Successfully deleted ${artifacts.length} artifact(s).`);

            } catch (error) {
              core.setFailed(`Failed to delete artifacts for run ${run_id}: ${error.message}`);
            }
